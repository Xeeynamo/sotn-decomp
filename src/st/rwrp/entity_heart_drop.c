#include "rwrp.h"
// Bizarre variable - u16 here, but u8 in EntityHolyGlassesCutscene
extern u16 D_80180608[];

#define HEART_DROP_OFFSET 0x2f8;

void EntityHeartDrop(Entity* self) {
    u16 temp_a0;
    u16 temp_a0_2;
    u16 var_a0;

    if (self->step == 0) {
        temp_a0 = self->params + HEART_DROP_OFFSET;
        self->ext.heartDrop.unkB4 = temp_a0;
        if ((D_8003BEEC[temp_a0 >> 3] >> (temp_a0 & 7)) & 1) {
            DestroyEntity(self);
            return;
        }
        temp_a0_2 = temp_a0 - HEART_DROP_OFFSET;
        var_a0 = D_80180608[temp_a0_2];
        if (var_a0 < 128) {
            self->ext.heartDrop.update = EntityPrizeDrop;
        } else {
            self->ext.heartDrop.update = EntityEquipItemDrop;
            var_a0 -= 128;
        }
        self->params = var_a0 + 0x8000;
    } else {
        temp_a0_2 = self->ext.heartDrop.unkB4;
        if (self->step < 5) {
            if (self->hitFlags != 0) {
                var_a0 = self->ext.heartDrop.unkB4;
                D_8003BEEC[temp_a0_2 >> 3] |= 1 << (var_a0 & 7);
                self->step = 5;
            }
        }
    }
    self->ext.heartDrop.update(self);
}
