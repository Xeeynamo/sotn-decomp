// SPDX-License-Identifier: AGPL-3.0-or-later
#include "lib.h"

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", ST0_EntityBackgroundBlock);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", PlayerIsWithinHitbox);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_801B0AA4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AE4BC);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AE7AC);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AE84C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AE8E8);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AF280);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AF538);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AF7B8);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AFA80);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AB960);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AB988);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AB9A4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AB9C0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AB9D8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABA0C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABA30);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABA48);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABA60);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABA90);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABAA8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABAC4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABAE4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABB00);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABB20);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABB40);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABB74);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABBA4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABBD4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABBF0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABC0C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABC28);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABC38);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABC50);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABC90);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABCAC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABCCC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABCF8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABD18);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABD34);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABD58);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABD78);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABD98);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABDB4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABDD8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABDEC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABE1C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABE38);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABE58);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABE78);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABEA8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABED8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABEF8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABF24);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABF44);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABF58);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABF7C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABFA8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABFC8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABFDC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ABFF8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC02C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC054);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC08C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC0A0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC0B4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC0F4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC120);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC138);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC15C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC188);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC1B0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC1E4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC200);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC234);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC26C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC284);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC2A4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC2E0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC318);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC338);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC350);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC380);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC398);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC3C4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC3DC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC400);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC418);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC42C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC44C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC474);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC4A4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC4D8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC4F0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC50C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC528);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC548);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC57C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC5B0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC5DC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC600);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC618);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC630);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC64C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC66C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC684);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC6AC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC6D8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC6FC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC72C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC74C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC784);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC7A4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC7C4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC7E8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC818);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC834);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC868);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC8A0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC8B8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC8E0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC908);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC938);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC954);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC974);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC9A0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC9C4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AC9E8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACA0C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACA24);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACA58);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACA8C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACAAC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACAC8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACAE4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACB04);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACB28);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACB48);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACB60);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACB7C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACBB4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACBCC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACBF4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACC2C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACC4C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACC74);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACC94);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACCC8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACCF0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACD10);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACD3C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACD60);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801AFE0C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B037C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B0C40);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B0FBC);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B1064);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B11A0);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B1200);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B12D0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACDE0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACDEC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACDF4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACE00);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACE0C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACE18);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B15C0);

void func_us_801B245C(Primitive* arg0, u16 arg1, u16 arg2, s32 arg3, u16 arg4,
                      s32 arg5, s32 arg6);
INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B245C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B29C4);

typedef struct {
    u16 unk0;
    u16 unk2;
    u32 unk4;
} unk_801B2BE4;

extern u16 D_us_801814D4[];
extern unk_801B2BE4 D_us_801814D8[];
extern u16 D_us_80181510[];
extern u32 D_us_801D415C[];
extern s32 D_us_801D425C[];
extern unk_801B2BE4 D_us_801D4364[];
extern s32 g_CutsceneFlags;
extern u16 g_EInitCommon[];
extern s32 D_psp_08B42050;
extern s32 D_psp_08B42054;

void func_us_801B2BE4(Entity* self) {
    Primitive* prim;
    s32 i;
    s16 index;
    s16 tempVar;
    unk_801B2BE4* ptr;
    s32 primIndex;

#ifndef VERSION_PSP
    if (g_CastleFlags[CASTLE_FLAG_98]) {
        FntPrint("HIP ");
    }
    if (g_CastleFlags[CASTLE_FLAG_180]) {
        FntPrint("ARE ");
    }
    if (g_Status.relics[RELIC_SOUL_OF_BAT] & RELIC_FLAG_FOUND) {
        FntPrint("BAT ");
    }
    if (g_CastleFlags[HG_CS_DONE]) {
        FntPrint("CEN ");
    }
    if (g_CastleFlags[CASTLE_FLAG_150]) {
        FntPrint("REV ");
    }
    if (g_CastleFlags[CASTLE_FLAG_220]) {
        FntPrint("DET ");
    }
    if (g_api.TimeAttackController(
            TIMEATTACK_EVENT_GALAMOTH_DEFEAT, TIMEATTACK_GET_RECORD)) {
        FntPrint("GAR ");
    }
    FntPrint("\n");
#endif

    switch (self->step) {
    case 0:
        primIndex = g_api.AllocPrimitives(PRIM_G4, 0xD);
        if (primIndex != -1) {
            InitializeEntity(g_EInitCommon);
            i = 0;
            self->flags |= FLAG_HAS_PRIMS;
            self->primIndex = primIndex;
            prim = &g_PrimBuf[primIndex];
            while (prim != NULL) {
                if (i < 6) {
                    prim->type = PRIM_LINE_G2;
                    prim->r0 = prim->r1 = 0x80;
                    prim->g0 = prim->g1 = 0x80;
                    prim->b0 = prim->b1 = 0x80;
                    prim->priority = 0x1FC;
                    prim->drawMode = DRAW_HIDE;
                } else if (i < 8) {
                    prim->x0 = prim->x1 = prim->x2 = prim->x3 = 0x80;
                    prim->y0 = prim->y1 = 0x18;
                    prim->y2 = prim->y3 = 0x78;
                    prim->priority = 0x1FA;
                    prim->drawMode = DRAW_HIDE;
                } else if (i < 10) {
                    prim->type = PRIM_GT4;
#ifdef VERSION_PSP
                    prim->tpage = 0x110;
#else
                    prim->tpage = 0x114;
#endif
                    prim->u0 = prim->u2 = (i - 8) * 0x6C + 8;
                    prim->u1 = prim->u3 = prim->u0 + 0x6C;
                    prim->v0 = prim->v1 = 0xD;
                    prim->v2 = prim->v3 = 0x61;
                    prim->x0 = prim->x1 = prim->x2 = prim->x3 = 0x80;
                    prim->y0 = prim->y1 = 0x1E;
                    prim->y2 = prim->y3 = 0x72;
                    prim->priority = 0x1FC;
                    prim->drawMode = DRAW_HIDE;
                } else if (i == 10) {
                    prim->x0 = prim->x2 = 0x11;
                    prim->x1 = prim->x3 = 0xEF;
                    prim->y0 = prim->y1 = 0x2B;
                    prim->y2 = prim->y3 = 0x37;
                    prim->r0 = prim->r1 = prim->r2 = prim->r3 = 0x40;
                    prim->g0 = prim->g1 = prim->g2 = prim->g3 = 0x10;
                    prim->b0 = prim->b1 = prim->b2 = prim->b3 = 0x10;
                    prim->priority = 0x1FB;
                    prim->drawMode = DRAW_HIDE;
                } else {
                    prim->type = PRIM_GT4;
                    prim->tpage = 0x1E;
                    prim->clut = 0x17F;
                    prim->u0 = prim->u2 = 0x58;
                    prim->u1 = prim->u3 = 0x60;
                    prim->v0 = prim->v1 = (i - 11) * 8 + 0x70;
                    prim->v2 = prim->v3 = 0x78 - (i - 11) * 8;
                    prim->x0 = prim->x2 = 0x7C;
                    prim->x1 = prim->x3 = prim->x0 + 8;
                    prim->y0 = prim->y1 = (i - 11) * 0x60 + 0x14;
                    prim->y2 = prim->y3 = prim->y0 + 8;
                    prim->priority = 0x1FC;
                    prim->drawMode = DRAW_HIDE;
                }
                prim = prim->next;
                i++;
            }
        }
        break;

    case 1:
        if (g_CutsceneFlags & 0x400) {
            SetStep(2);
            if (self->params) {
                ptr = D_us_801814D8;
            } else {
                self->ext.et_801B2BE4.unk88 = func_us_801B29C4();
                ptr = D_us_801D4364;
            }
            for (i = 0; i < 64; i++) {
                index = ptr->unk2;
                switch (ptr->unk0) {
                case 0:
                    tempVar = g_Status.equipHandCount[index];
                    if (g_Status.equipment[LEFT_HAND_SLOT] == index) {
                        tempVar++;
                    }
                    if (g_Status.equipment[RIGHT_HAND_SLOT] == index) {
                        tempVar++;
                    }
                    D_us_801D425C[i] = 99 - tempVar;
                    break;

                case 1:
                    tempVar = g_Status.equipBodyCount[index];
                    if (g_Status.equipment[HEAD_SLOT] == index) {
                        tempVar++;
                    }
                    D_us_801D425C[i] = 99 - tempVar;
                    break;

                case 2:
                    tempVar = g_Status.equipBodyCount[index];
                    if (g_Status.equipment[ARMOR_SLOT] == index) {
                        tempVar++;
                    }
                    D_us_801D425C[i] = 99 - tempVar;
                    break;

                case 3:
                    tempVar = g_Status.equipBodyCount[index];
                    if (g_Status.equipment[CAPE_SLOT] == index) {
                        tempVar++;
                    }
                    D_us_801D425C[i] = 99 - tempVar;
                    break;

                case 4:
                    tempVar = g_Status.equipBodyCount[index];
                    if (self->params) {
                        D_us_801D425C[i] = tempVar;
                    } else {
                        if (g_Status.equipment[ACCESSORY_1_SLOT] == index) {
                            tempVar++;
                        }
                        if (g_Status.equipment[ACCESSORY_2_SLOT] == index) {
                            tempVar++;
                        }
                        D_us_801D425C[i] = 99 - tempVar;
                        break;
                    }
                    break;

                case 5:
                    index = D_us_801814D4[index];
                    if (g_Status.relics[index] & RELIC_FLAG_FOUND) {
                        D_us_801D425C[i] = 0;
                    } else {
                        D_us_801D425C[i] = 1;
                    }
                    break;

                default:
                    D_us_801D425C[i] = 1;
                    break;
                }
                if (D_us_801D425C[i]) {
                    D_us_801D415C[i] = 1;
                } else {
                    D_us_801D415C[i] = 0;
                }
                ptr++;
            }
            self->ext.et_801B2BE4.unk7C = 0;
            self->ext.et_801B2BE4.unk7E = 0;
            self->ext.et_801B2BE4.unk80 = 0;
            self->ext.et_801B2BE4.unk82 = 0;
        }
        break;

    case 2:
        self->ext.et_801B2BE4.unk7C++;
        self->ext.et_801B2BE4.unk7E += 0x40;
        prim = &g_PrimBuf[self->primIndex];
        func_us_801B245C(prim, self->ext.et_801B2BE4.unk7E,
                         self->ext.et_801B2BE4.unk7C * 2, 0x74, 0x20, 8, 1);
        if (self->ext.et_801B2BE4.unk7C == 0x10) {
            if (self->params) {
                SetStep(5);
            } else {
                SetStep(3);
            }
        }
        break;

    case 3:
        tempVar = g_pads[0].repeat;
        FntPrint("kosuu %x\n", self->ext.et_801B2BE4.unk82);
        if (tempVar & PAD_DOWN) {
            if (self->ext.et_801B2BE4.unk80 < 6) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk80++;
            } else if (
                self->ext.et_801B2BE4.unk82 < self->ext.et_801B2BE4.unk88) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk82++;
            }
        } else if (tempVar & PAD_UP) {
            if (self->ext.et_801B2BE4.unk80 > 0) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk80--;
            } else if (self->ext.et_801B2BE4.unk82) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk82--;
            }
#ifdef VERSION_PSP
        } else if (tempVar & 0x600) {
#else
        } else if (tempVar & (PAD_R1 + PAD_R2)) {
#endif
            if (self->ext.et_801B2BE4.unk80 < 6) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk80 = 6;
            } else if (
                self->ext.et_801B2BE4.unk82 < self->ext.et_801B2BE4.unk88) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk82 += 7;
                if (self->ext.et_801B2BE4.unk82 > self->ext.et_801B2BE4.unk88) {
                    self->ext.et_801B2BE4.unk82 = self->ext.et_801B2BE4.unk88;
                }
            }
#ifdef VERSION_PSP
        } else if (tempVar & 0x102) {
#else
        } else if (tempVar & (PAD_L1 + PAD_L2)) {
#endif
            if (self->ext.et_801B2BE4.unk80 > 0) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk80 = 0;
            } else if (self->ext.et_801B2BE4.unk82) {
                g_api.PlaySfx(SFX_UI_MOVE);
                if (self->ext.et_801B2BE4.unk82 > 7) {
                    self->ext.et_801B2BE4.unk82 -= 7;
                } else {
                    self->ext.et_801B2BE4.unk82 = 0;
                }
            }
        }
        index = self->ext.et_801B2BE4.unk82 + self->ext.et_801B2BE4.unk80;
        if (tempVar & PAD_RIGHT) {
            if (D_us_801D415C[index] < D_us_801D425C[index]) {
                g_api.PlaySfx(SFX_UI_MOVE);
                D_us_801D415C[index]++;
            }
        } else if (tempVar & PAD_LEFT) {
            if (D_us_801D415C[index] > 1) {
                g_api.PlaySfx(SFX_UI_MOVE);
                D_us_801D415C[index]--;
            }
        }
        tempVar = g_pads[0].tapped;
#ifdef VERSION_PSP
        if (tempVar & D_psp_08B42050) {
#else
        if (tempVar & PAD_CROSS) {
#endif
            if (g_Status.gold <
                    D_us_801D415C[index] * D_us_801D4364[index].unk4 ||
                !D_us_801D415C[index]) {
                g_api.PlaySfx(SFX_UI_ERROR);
            } else {
                g_Status.gold -=
                    D_us_801D415C[index] * D_us_801D4364[index].unk4;
                switch (D_us_801D4364[index].unk0) {
                case 0:
                    tempVar = 0;
                    break;
                case 1:
                    tempVar = 1;
                    break;
                case 2:
                    tempVar = 2;
                    break;
                case 3:
                    tempVar = 3;
                    break;
                case 4:
                    tempVar = 4;
                    break;
                }
                if (D_us_801D4364[index].unk0 < 5) {
                    for (i = 0; i < D_us_801D415C[index]; i++) {
                        g_api.AddToInventory(
                            D_us_801D4364[index].unk2, (enum EquipKind)tempVar);
                    }
                } else {
                    if (D_us_801D4364[index].unk0 == 5) {
                        g_api.func_800FE044(
                            D_us_801814D4[D_us_801D4364[index].unk2], 0x2000);
                    } else {
                        if (D_us_801D4364[index].unk2) {
                            g_api.LearnSpell(
                                D_us_80181510[D_us_801D4364[index].unk2 - 1]);
                        } else {
                            g_api.func_800F2288(0);
                            g_CastleFlags[CASTLE_FLAG_115] = 1;
                        }
                    }
                }
                D_us_801D425C[index] -= D_us_801D415C[index];
                if (D_us_801D425C[index]) {
                    D_us_801D415C[index] = 1;
                } else {
                    D_us_801D415C[index] = 0;
                }
                SetStep(4);
                g_api.PlaySfx(SFX_UI_CONFIRM);
            }
#ifdef VERSION_PSP
        } else if (tempVar & D_psp_08B42054) {
#else
        } else if (tempVar & PAD_TRIANGLE) {
#endif
            SetStep(7);
        }
        prim = &g_PrimBuf[self->primIndex];
        for (i = 0; i < 10; i++) {
            prim = prim->next;
        }
        prim->y0 = prim->y1 = (self->ext.et_801B2BE4.unk80 * 0xC) + 0x1F;
        prim->y2 = prim->y3 = prim->y0 + 0xC;
        prim->drawMode = DRAW_COLORS;

        prim = prim->next;
        if (self->ext.et_801B2BE4.unk82) {
            prim->drawMode = DRAW_DEFAULT;
        } else {
            prim->drawMode = DRAW_HIDE;
        }

        prim = prim->next;
        if (self->ext.et_801B2BE4.unk82 < self->ext.et_801B2BE4.unk88) {
            prim->drawMode = DRAW_DEFAULT;
        } else {
            prim->drawMode = DRAW_HIDE;
        }
        break;

    case 4:
        switch (self->step_s) {
        case 0:
            if (g_api.func_80131F68()) {
                g_api.PlaySfx(SET_STOP_MUSIC);
                self->step_s++;
            } else {
                self->step_s++;
            }
            break;

        case 1:
            if (!g_api.func_80131F68()) {
                g_CutsceneFlags |= 0x800;
                g_api.PlaySfx(NA_VO_LI_THANKS);
                SetStep(3);
            }
            break;
        }
        break;

    case 5:
        tempVar = g_pads[0].repeat;
        if (tempVar & PAD_DOWN) {
            if (self->ext.et_801B2BE4.unk80 < 6) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk80++;
            } else if (self->ext.et_801B2BE4.unk82 < 0) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk82++;
            }
        } else if (tempVar & PAD_UP) {
            if (self->ext.et_801B2BE4.unk80 > 0) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk80--;
            } else if (self->ext.et_801B2BE4.unk82) {
                g_api.PlaySfx(SFX_UI_MOVE);
                self->ext.et_801B2BE4.unk82--;
            }
        }
        index = self->ext.et_801B2BE4.unk82 + self->ext.et_801B2BE4.unk80;
        if (tempVar & PAD_RIGHT) {
            if (D_us_801D415C[index] < D_us_801D425C[index]) {
                g_api.PlaySfx(SFX_UI_MOVE);
                D_us_801D415C[index]++;
            }
        } else if (tempVar & PAD_LEFT) {
            if (D_us_801D415C[index] > 1) {
                g_api.PlaySfx(SFX_UI_MOVE);
                D_us_801D415C[index]--;
            }
        }
        tempVar = g_pads[0].tapped;
#ifdef VERSION_PSP
        if (tempVar & D_psp_08B42050) {
#else
        if (tempVar & PAD_CROSS) {
#endif
            if (D_us_801D415C[index] == 0) {
                g_api.PlaySfx(SFX_UI_ERROR);
            } else {
                g_Status.gold +=
                    D_us_801D415C[index] * D_us_801814D8[index].unk4;
                if (g_Status.gold > 0xF423F) {
                    g_Status.gold = 0xF423F;
                }
                ptr = &D_us_801814D8[index];
                g_Status.equipBodyCount[ptr->unk2] -= D_us_801D415C[index];
                D_us_801D425C[index] -= D_us_801D415C[index];
                D_us_801D415C[index] = 0;
                SetStep(6);
                g_api.PlaySfx(SFX_UI_CONFIRM);
            }
#ifdef VERSION_PSP
        } else if (tempVar & D_psp_08B42054) {
#else
        } else if (tempVar & PAD_TRIANGLE) {
#endif
            SetStep(7);
        }
        prim = &g_PrimBuf[self->primIndex];
        for (i = 0; i < 10; i++) {
            prim = prim->next;
        }
        prim->y0 = prim->y1 = (self->ext.et_801B2BE4.unk80 * 0xC) + 0x1F;
        prim->y2 = prim->y3 = prim->y0 + 0xC;
        prim->drawMode = DRAW_COLORS;

        prim = prim->next;
        if (self->ext.et_801B2BE4.unk82) {
            prim->drawMode = DRAW_DEFAULT;
        } else {
            prim->drawMode = DRAW_HIDE;
        }

        prim = prim->next;
        if (self->ext.et_801B2BE4.unk82 < 0) {
            prim->drawMode = DRAW_DEFAULT;
        } else {
            prim->drawMode = DRAW_HIDE;
        }
        break;

    case 6:
        switch (self->step_s) {
        case 0:
            if (g_api.func_80131F68()) {
                g_api.PlaySfx(SET_STOP_MUSIC);
                self->step_s++;
            } else {
                self->step_s++;
            }
            break;

        case 1:
            if (!g_api.func_80131F68()) {
                g_CutsceneFlags |= 0x800;
                g_api.PlaySfx(NA_VO_LI_THANKS);
                SetStep(5);
            }
            break;
        }
        break;

    case 7:
        if ((g_CutsceneFlags & 0x200) == 0) {
            prim = &g_PrimBuf[self->primIndex];
            for (i = 0; i < 10; i++) {
                prim = prim->next;
            }
            prim->drawMode = DRAW_HIDE;
            prim = prim->next;

            prim->drawMode = DRAW_HIDE;
            prim = prim->next;

            prim->drawMode = DRAW_HIDE;
            self->ext.et_801B2BE4.unk7E = 0x400;
            self->ext.et_801B2BE4.unk7C = 0x10;
            self->step++;
            g_CutsceneFlags |= 0x200;
        }
        break;

    case 8:
        self->ext.et_801B2BE4.unk7C--;
        self->ext.et_801B2BE4.unk7E -= 0x40;
        prim = &g_PrimBuf[self->primIndex];
        func_us_801B245C(prim, self->ext.et_801B2BE4.unk7E,
                         self->ext.et_801B2BE4.unk7C * 2, 0x74, 0x20, 8, 1);
        if (self->ext.et_801B2BE4.unk7C == 1) {
            g_CutsceneFlags &= ~0x400;
        }
        if (!self->ext.et_801B2BE4.unk7C) {
            DestroyEntity(self);
        }
        break;
    }
}

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B3EC8);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B3FB4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B4010);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B4080);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B40F0);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B4194);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACF14);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACF18);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACF1C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACF24);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACF34);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACF40);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B420C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B4830);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACF88);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACFA4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACFC4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801ACFE0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD000);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD024);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B4ED4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B5068);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD088);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD098);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD0A8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD0B8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD0C8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD0D8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD0E8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD0F4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B56E4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B5F18);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B5F84);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B60C8);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B6124);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD134);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD144);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD14C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD150);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD15C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD16C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD178);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD188);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD198);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD1A8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD1B0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD1C4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD1D0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD1D8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD1EC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD1F8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD204);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD210);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD21C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD22C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD234);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD248);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD254);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD264);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD26C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B6324);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B6E20);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B6F30);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B7C94);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B7D10);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B7DF8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD2C8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD2DC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD2F0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD304);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD314);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD324);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD330);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD33C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD348);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD350);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD35C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD360);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD36C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD374);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD37C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD384);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD38C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD394);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD39C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3A4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3AC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3B4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3B8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3C4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3CC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3D4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3DC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3E4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3EC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3F4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD3FC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD404);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD40C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD414);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD41C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD424);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD42C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD438);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD440);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD44C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD450);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD458);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD464);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD46C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD470);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD474);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD478);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD484);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B8234);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B8958);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD4CC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD4DC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD4F0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD500);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD510);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD524);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD538);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD548);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD55C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD570);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD584);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD598);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD5AC);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD5B8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD5C8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD5D8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD5E4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD5F8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD608);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD61C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD634);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD64C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD664);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD67C);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD694);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD6A4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD6B4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD6C4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD6D8);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD6E0);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD6F4);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD708);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD714);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B8A00);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", CutsceneUnk1);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", SetCutsceneScript);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801B9804);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", CutsceneUnk4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", DrawCutsceneActorName);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", SetCutsceneEnd);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", CutsceneRun);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_80194F14);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", ScaleCutsceneAvatar);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD760);

INCLUDE_RODATA("st/lib/nonmatchings/first_c_file", D_us_801AD774);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", LIB_EntityCutscene);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BAF60);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BB200);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BB53C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BB8DC);

u8 func_us_801BBAB4(void);
INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BBAB4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BBEB0);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BC28C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BC57C);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BC814);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BCC10);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BCFD4);

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BD268);

u8 func_us_801BDA34(void);
INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BDA34);

extern u16 D_us_80180968[];
extern s32 D_us_80181ACC;
extern s16 D_us_80181AD4[];
extern u8 D_us_80181B04[];
extern u8 D_us_80181B14[];
extern u8 D_us_80181B2C[];
extern u8 D_us_80181B34[];
extern u8 D_us_80181B44[];
extern u8 D_us_80181B4C[];
extern u8 D_us_80181B68[];
extern u8 D_us_80181B84[];
extern u8 D_us_80181B90[];
extern u8 D_us_80181B9C[];
extern u8 D_us_80181BAC[];
extern u8 D_us_80181BBC[];
extern s16 D_us_80181C34[];
extern s32 D_psp_08B42050;
extern s32 D_psp_092A5668;
extern s32 D_psp_092A5670;
extern s32 D_psp_092A5678;

void func_us_801BDAE4(Entity* self) {
    Collider collider;
    Entity* tempEntity;
    s32 xOffset, yOffset;
    s32 i;
    u8 hit;
    s16 posX, posY;
    s16 tempVar;

    FntPrint("step     %x\n", self->step);
    FntPrint("step_s   %x\n", self->step_s);
    if ((self->flags & FLAG_DEAD) && (self->step < 15)) {
        if (self->flags & FLAG_HAS_PRIMS) {
            g_api.FreePrimitives(self->primIndex);
            self->flags &= ~FLAG_HAS_PRIMS;
        }
        self->hitboxState = 0;
        SetStep(15);
    }
    switch (self->step) {
    case 0:
        InitializeEntity(D_us_80180968);
        self->flags &= ~(FLAG_UNK_800 | FLAG_UNK_400);
        self->zPriority -= 2;
        self->hitboxOffX = 0;
        self->hitboxOffY = 2;
        break;

    case 1:
        if (UnkCollisionFunc3(D_us_80181AD4) & 1) {
            SetStep(2);
        }
        break;

    case 2:
        self->hitboxState = 0;
        self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
        if (D_us_80181ACC & 1) {
            self->hitboxState = 3;
            SetStep(3);
        }
        break;

    case 3:
        if (!self->step_s) {
            self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
            self->ext.et_801BDAE4.unk80 = 0x30;
            self->step_s++;
        }
        hit = func_us_801BDA34();
        if (hit) {
            self->facingLeft ^= 1;
        }
        if (!AnimateEntity(D_us_80181B04, self)) {
            self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
        }
        xOffset = self->posX.i.hi + g_Tilemap.scrollX.i.hi;
        if (xOffset < 0x160) {
            self->facingLeft = 1;
            SetStep(6);
        }
        if (xOffset > 0x2B0) {
            self->facingLeft = 0;
            SetStep(6);
        }
        if (!--self->ext.et_801BDAE4.unk80) {
            if (!(self->posX.i.hi & 0xFF00)) {
                if (Random() & 3) {
                    self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
                    self->ext.et_801BDAE4.unk84 = 0;
                    SetStep(13);
                    if ((GetDistanceToPlayerX() < 0x40) && (Random() & 3)) {
                        SetStep(4);
                    }
                } else {
                    SetStep(8);
                }
            } else {
                SetStep(8);
            }
        }
        break;

    case 6:
        switch (self->step_s) {
        case 0:
            if (!AnimateEntity(D_us_80181B2C, self)) {
                self->animFrameIdx = 0;
                self->animFrameDuration = 0;
                self->step_s++;
                self->velocityY = FIX(-6.0);
                if (self->facingLeft) {
                    self->velocityX = FIX(1.5);
                } else {
                    self->velocityX = FIX(-1.5);
                }
            }
            break;

        case 1:
            AnimateEntity(D_us_80181B34, self);
            if (UnkCollisionFunc3(D_us_80181AD4) & 1) {
                PlaySfxPositional(SFX_STOMP_HARD_B);
                self->animFrameIdx = 0;
                self->animFrameDuration = 0;
                self->step_s++;
            } else {
                self->velocityY -= FIX(0.125);
            }
            break;

        case 2:
            if (!AnimateEntity(D_us_80181B44, self)) {
                SetStep(3);
            }
            break;
        }
        break;

    case 8:
        if (!AnimateEntity(D_us_80181B4C, self)) {
            self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
        }
        if (!self->animFrameDuration && self->animFrameIdx == 7) {
            PlaySfxPositional(SFX_WING_FLAP_B);
        }
        MoveEntity();
        self->velocityX = 0;
        self->velocityY = FIX(-1.5);
        if (self->posY.i.hi < 0x50) {
            self->velocityY = 0;
            SetStep(9);
        }
        break;

    case 9:
        if (!self->step_s) {
            self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
            self->ext.et_801BDAE4.unk80 = D_us_80181C34[Random() & 3];
            self->step_s++;
        }
        AnimateEntity(D_us_80181B4C, self);
        MoveEntity();
        if (!self->animFrameDuration && self->animFrameIdx == 7) {
            PlaySfxPositional(SFX_WING_FLAP_B);
        }
        if (self->facingLeft) {
            self->velocityX = FIX(1.0);
        } else {
            self->velocityX = FIX(-1.0);
        }
        if (!--self->ext.et_801BDAE4.unk80) {
            self->step_s--;
            if (self->posX.i.hi & 0xFF00) {
                if (Random() & 3) {
                    SetStep(14);
                } else {
                    SetStep(10);
                }
            } else {
                tempVar = GetDistanceToPlayerX();
                if (tempVar > 0x40) {
                    if ((Random() & 7) == 0) {
                        SetStep(4);
                    } else {
                        SetStep(12);
                        if ((Random() & 3) == 0) {
                            SetStep(14);
                        }
                    }
                } else {
                    SetStep(14);
                }
            }
            if (self->posY.i.hi < 0) {
                SetStep(11);
            }
        }
        break;

    case 10:
        if (!self->step_s) {
            self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
            if (self->facingLeft) {
                self->velocityX = FIX(2.0);
            } else {
                self->velocityX = FIX(-2.0);
            }
            self->ext.et_801BDAE4.unk80 = 0x60;
            self->step_s++;
            break;
        }
        MoveEntity();
        AnimateEntity(D_us_80181B68, self);
        if (g_Timer % 8 == 0) {
            PlaySfxPositional(SFX_WING_FLAP_B);
        }
        if (!--self->ext.et_801BDAE4.unk80) {
            SetStep(9);
        }
        break;

    case 4:
        switch (self->step_s) {
        case 0:
            tempEntity = &PLAYER;
            posX = tempEntity->posX.i.hi - self->posX.i.hi;
            posY = tempEntity->posY.i.hi - self->posY.i.hi;
            if (posX < 0) {
                posX += 0x20;
            } else {
                posX -= 0x20;
            }
            posY += 0x1A;
            tempVar = ratan2(-posY, posX);
            self->velocityX = rcos(tempVar) * 0x40;
            self->velocityY = -rsin(tempVar) * 0x40;
            if (self->velocityY < FIX(1.0)) {
                self->velocityY = FIX(1.0);
            }
            if (self->velocityX > 0) {
                self->facingLeft = 1;
            } else {
                self->facingLeft = 0;
            }
            tempEntity = AllocEntity(&g_Entities[160], &g_Entities[192]);
            if (tempEntity != NULL) {
#ifdef VERSION_PSP
                CreateEntityFromEntity(D_psp_092A5668, self, tempEntity);
#else
                CreateEntityFromEntity(E_ID_22, self, tempEntity);
#endif
                self->ext.et_801BDAE4.unk88 = tempEntity;
            } else {
                self->ext.et_801BDAE4.unk88 = NULL;
            }
            self->ext.et_801BDAE4.unk84 = 0;
            self->ext.et_801BDAE4.unk87 = 0;
            self->step_s++;
            /* fallthrough */
        case 1:
            MoveEntity();
            posX = self->posX.i.hi;
            posY = self->posY.i.hi + 0x20;
            g_api.CheckCollision(posX, posY, &collider, 0);
            if (collider.effects & EFFECT_SOLID) {
                PlaySfxPositional(SFX_STOMP_HARD_B);
                self->posY.i.hi += collider.unk18;
                self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
                self->step_s++;
                if (self->ext.et_801BDAE4.unk88 == NULL) {
                    SetStep(3);
                }
            } else {
                self->animCurFrame = 0x18;
            }
            break;

        case 2:
            tempEntity = self->ext.et_801BDAE4.unk88;
            if (!AnimateEntity(D_us_80181B14, self) &&
                !(self->flags & FLAG_HAS_PRIMS)) {
                self->ext.et_801BDAE4.unk87 = 0;
                DestroyEntity(tempEntity);
                SetStep(3);
                break;
            }
            if (!self->animFrameDuration && self->animFrameIdx == 5) {
                PlaySfxPositional(0x78F);
            }
            if (self->animFrameIdx > 4 && self->animFrameIdx < 11) {
                tempEntity->posX.i.hi = self->posX.i.hi;
                tempEntity->posY.i.hi = self->posY.i.hi;
                tempEntity->facingLeft = self->facingLeft;
                tempEntity->hitboxState = 1;
                self->ext.et_801BDAE4.unk87 = 1;
                if (self->facingLeft) {
                    EntityGreyPuffSpawner(self, 5, 3, -4, 32, 2, 7);
                } else {
                    EntityGreyPuffSpawner(self, 5, 3, 4, 32, 2, -7);
                }
            } else {
                tempEntity->hitboxState = 0;
            }
            break;
        }
        if (self->ext.et_801BDAE4.unk87) {
            func_us_801BC28C();
        }
        break;

    case 11:
        AnimateEntity(D_us_80181B4C, self);
        if (!self->animFrameDuration && self->animFrameIdx == 7) {
            PlaySfxPositional(SFX_WING_FLAP_B);
        }
        if (UnkCollisionFunc3(D_us_80181AD4) & 1) {
            PlaySfxPositional(SFX_STOMP_HARD_B);
            SetStep(3);
        }
        if (self->posY.i.hi > 0xD0) {
            SetStep(8);
        }
        break;

    case 12:
        switch (self->step_s) {
        case 0:
            self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
            AnimateEntity(D_us_80181B84, self);
            if (self->animFrameIdx == 2) {
                PlaySfxPositional(0x70E);
                self->ext.et_801BDAE4.unk84 = 0;
                self->step_s++;
                self->ext.et_801BDAE4.unk80 = 0;
            }
            break;

        case 1:
            if (func_us_801BBAB4()) {
                tempEntity = AllocEntity(&g_Entities[160], &g_Entities[192]);
                if (tempEntity != NULL) {
#ifdef VERSION_PSP
                    CreateEntityFromEntity(D_psp_092A5678, self, tempEntity);
#else
                    CreateEntityFromEntity(E_ID_20, self, tempEntity);
#endif
                    tempEntity->facingLeft = self->facingLeft;
                    if (self->facingLeft) {
                        tempEntity->posX.i.hi += 12;
                    } else {
                        tempEntity->posX.i.hi -= 12;
                    }
                    tempEntity->posY.i.hi -= 8;
                }
                self->ext.et_801BDAE4.unk84 = 0;
                PlaySfxPositional(SFX_FM_EXPLODE_D);
                self->step_s++;
            }
            break;

        case 2:
            if (!AnimateEntity(D_us_80181B84, self)) {
                SetStep(9);
            }
            break;
        }
        break;

    case 13:
        if (!self->step_s) {
            self->ext.et_801BDAE4.unk84 = 0;
            self->step_s++;
        }
        if (!AnimateEntity(D_us_80181B90, self)) {
            self->ext.et_801BDAE4.unk84 = 0;
            SetStep(3);
            break;
        }
        if (self->animFrameIdx == 3 && self->animFrameDuration == 0) {
            PlaySfxPositional(0x7D1);
            self->ext.et_801BDAE4.unk84 = 2;
            tempEntity = AllocEntity(&g_Entities[160], &g_Entities[192]);
            if (tempEntity != NULL) {
#ifdef VERSION_PSP
                CreateEntityFromEntity(D_psp_092A5670, self, tempEntity);
#else
                CreateEntityFromEntity(E_ID_21, self, tempEntity);
#endif
                tempEntity->facingLeft = self->facingLeft;
            }
        }
        if (self->animFrameIdx > 1) {
            func_us_801BC57C();
        }
        break;

    case 14:
        FntPrint("timer %x\n", self->ext.et_801BDAE4.unk80);
        switch (self->step_s) {
        case 0:
            posX = self->posX.i.hi;
            posY = self->posY.i.hi;
            tempVar = 0;
            hit = false;
            for (i = 0; i < 3; i++) {
                tempVar = posY + i * 16;
                g_api.CheckCollision(posX, tempVar, &collider, 0);
                if (collider.effects != EFFECT_NONE) {
                    self->ext.et_801BDAE4.unk87 = 0;
                    SetStep(9);
                    return;
                }
            }
            hit = false;
            for (i = 3; i < 10; i++) {
                tempVar = posY + i * 16;
                g_api.CheckCollision(posX, tempVar, &collider, 0);
                if (collider.effects != EFFECT_NONE) {
                    hit |= true;
                    break;
                }
            }
            if (!hit) {
                self->ext.et_801BDAE4.unk87 = 0;
                SetStep(9);
                return;
            }
            AnimateEntity(D_us_80181B9C, self);
            self->facingLeft = (GetSideToPlayer() & 1) ^ 1;
            if (self->animFrameIdx == 3) {
                self->ext.et_801BDAE4.unk84 = 0;
                PlaySfxPositional(SFX_RAPID_SYNTH_BUBBLE);
                self->step_s++;
                self->ext.et_801BDAE4.unk8C = self->hitPoints;
                self->hitPoints = 0x7FFF;
                self->ext.et_801BDAE4.unk80 = 0x80;
            }
            break;

        case 1:
            if (self->ext.et_801BDAE4.unk80 & 1) {
                self->palette = 0x249;
            } else {
                self->palette = 0x24E;
            }
            if (!--self->ext.et_801BDAE4.unk80) {
                self->palette = 0x249;
                self->hitEffect = 0x249;
                self->flags &= ~0xF;
                PlaySfxPositional(SFX_TELEPORT_BANG_A);
                self->hitPoints = self->ext.et_801BDAE4.unk8C;
                self->step_s++;
                self->ext.et_801BDAE4.unk84++;
            }
            func_us_801BD268();
            break;

        case 2:
            self->ext.et_801BDAE4.unk80--;
            if (!AnimateEntity(D_us_80181B9C, self) &&
                !(self->flags & FLAG_HAS_PRIMS)) {
                self->ext.et_801BDAE4.unk87 = 0;
                SetStep(9);
            } else {
                func_us_801BD268();
            }
            break;
        }
        break;

    case 15:
        self->palette = 0x8160;
        if (g_Timer % 7 == 0) {
            tempEntity = AllocEntity(&g_Entities[224], &g_Entities[256]);
            if (tempEntity != NULL) {
                CreateEntityFromEntity(E_INTENSE_EXPLOSION, self, tempEntity);
                tempEntity->posX.i.hi += (Random() & 0x1F) - 0x10;
                tempEntity->posY.i.hi += (Random() & 0x3F) - 0x20;
            }
        }
        if ((g_Timer & 0xF) == 0) {
            PlaySfxPositional(SFX_EXPLODE_B);
        }
        switch (self->step_s) {
        case 0:
            self->hitboxState = 0;
            D_us_80181ACC |= 2;
            self->step_s++;
            /* fallthrough */
        case 1:
            AnimateEntity(D_us_80181B4C, self);
            if (!self->animFrameDuration && self->animFrameIdx == 7) {
                PlaySfxPositional(SFX_WING_FLAP_B);
            }
            if (UnkCollisionFunc3(D_us_80181AD4) & 1) {
                self->step_s++;
                self->animFrameIdx = 0;
                self->animFrameDuration = 0;
            } else {
                self->velocityY -= FIX(3.5 / 16);
            }
            break;

        case 2:
            hit = func_us_801BDA34();
            if (!AnimateEntity(D_us_80181BAC, self) || hit) {
                self->animFrameIdx = 0;
                self->animFrameDuration = 0;
                self->drawFlags = FLAG_DRAW_UNK8;
                self->drawMode = DRAW_TPAGE2 | DRAW_TPAGE;
                self->unk6C = 0x80;
                self->ext.et_801BDAE4.unk80 = 0x40;
                self->step_s++;
            }
            break;

        case 3:
            AnimateEntity(D_us_80181BBC, self);
            self->unk6C -= 2;
            if (g_Timer % 5 == 0) {
                tempEntity = AllocEntity(&g_Entities[224], &g_Entities[256]);
                if (tempEntity != NULL) {
                    CreateEntityFromEntity(E_EXPLOSION, self, tempEntity);
                    tempEntity->params = 1;
                    tempEntity->posX.i.hi += (Random() & 0x1F) - 0x10;
                    tempEntity->posY.i.hi += (Random() & 0x1F) - 0x10;
                }
            }
            if (!--self->ext.et_801BDAE4.unk80) {
                PlaySfxPositional(SFX_EXPLODE_SMALL);
                self->animCurFrame = 0;
                D_us_80181ACC |= 4;
                self->step_s++;
            }
            break;

        case 4:
            DestroyEntity(self);
            return;
        }
        break;

    case 32:
        FntPrint("charal %x\n", self->animCurFrame);
        if (g_pads[1].pressed & PAD_SQUARE) {
            if (self->params) {
                break;
            }
            self->animCurFrame++;
            self->params |= 1;
        } else {
            self->params = 0;
        }
#ifdef VERSION_PSP
        if (g_pads[1].pressed & D_psp_08B42050) {
#else
        if (g_pads[1].pressed & PAD_CIRCLE) {
#endif
            if (!self->step_s) {
                self->animCurFrame--;
                self->step_s |= 1;
            }
        } else {
            self->step_s = 0;
        }
        break;
    }
    xOffset = self->posX.i.hi + g_Tilemap.scrollX.i.hi;
    yOffset = self->posY.i.hi + g_Tilemap.scrollY.i.hi;
    if (xOffset < 0x138) {
        self->posX.i.hi = 0x138 - g_Tilemap.scrollX.i.hi;
    }
    if (xOffset > 0x2C8) {
        self->posX.i.hi = 0x2C8 - g_Tilemap.scrollX.i.hi;
    }
    if (yOffset < 0x230) {
        self->posY.i.hi = 0x230 - g_Tilemap.scrollY.i.hi;
    }
    if (yOffset > 0x2A0) {
        self->posY.i.hi = 0x2A0 - g_Tilemap.scrollY.i.hi;
    }
}

INCLUDE_ASM("st/lib/nonmatchings/first_c_file", func_us_801BED48);
